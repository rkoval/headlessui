"use client";import{useFocusRing as De}from"@react-aria/focus";import{useHover as _e}from"@react-aria/interactions";import h,{Fragment as Oe,createContext as se,createRef as Ie,useCallback as pe,useContext as ue,useEffect as Ce,useMemo as w,useReducer as Fe,useRef as de,useState as Me}from"react";import{flushSync as N}from"react-dom";import{useActivePress as Be}from'../../hooks/use-active-press.js';import{useByComparator as we}from'../../hooks/use-by-comparator.js';import{useControllable as ke}from'../../hooks/use-controllable.js';import{useDefaultValue as Ue}from'../../hooks/use-default-value.js';import{useDidElementMove as Ne}from'../../hooks/use-did-element-move.js';import{useDisposables as ye}from'../../hooks/use-disposables.js';import{useElementSize as He}from'../../hooks/use-element-size.js';import{useEvent as T}from'../../hooks/use-event.js';import{useId as ce}from'../../hooks/use-id.js';import{useInertOthers as Ge}from'../../hooks/use-inert-others.js';import{useIsoMorphicEffect as fe}from'../../hooks/use-iso-morphic-effect.js';import{useLatestValue as Ve}from'../../hooks/use-latest-value.js';import{useOnDisappear as Ke}from'../../hooks/use-on-disappear.js';import{useOutsideClick as je}from'../../hooks/use-outside-click.js';import{useOwnerDocument as ve}from'../../hooks/use-owner.js';import{useResolveButtonType as ze}from'../../hooks/use-resolve-button-type.js';import{useScrollLock as We}from'../../hooks/use-scroll-lock.js';import{useSyncRefs as j}from'../../hooks/use-sync-refs.js';import{useTextValue as Qe}from'../../hooks/use-text-value.js';import{useTrackedPointer as Xe}from'../../hooks/use-tracked-pointer.js';import{transitionDataAttributes as Je,useTransition as $e}from'../../hooks/use-transition.js';import{useDisabled as qe}from'../../internal/disabled.js';import{FloatingProvider as Ye,useFloatingPanel as Ze,useFloatingPanelProps as et,useFloatingReference as tt,useFloatingReferenceProps as ot,useResolvedAnchor as nt}from'../../internal/floating.js';import{FormFields as it}from'../../internal/form-fields.js';import{useFrozenData as rt}from'../../internal/frozen.js';import{useProvidedId as lt}from'../../internal/id.js';import{OpenClosedProvider as at,State as Y,useOpenClosed as st}from'../../internal/open-closed.js';import{isDisabledReactIssue7711 as pt}from'../../utils/bugs.js';import{Focus as v,calculateActiveIndex as be}from'../../utils/calculate-active-index.js';import{disposables as ut}from'../../utils/disposables.js';import{Focus as ge,FocusableMode as dt,focusFrom as ct,isFocusableElement as ft,sortByDomNode as bt}from'../../utils/focus-management.js';import{attemptSubmit as Tt}from'../../utils/form.js';import{match as V}from'../../utils/match.js';import{getOwnerDocument as mt}from'../../utils/owner.js';import{RenderFeatures as Le,forwardRefWithAs as z,mergeProps as Se,useRender as W}from'../../utils/render.js';import{useDescribedBy as xt}from'../description/description.js';import{Keys as S}from'../keyboard.js';import{Label as Ot,useLabelledBy as yt,useLabels as vt}from'../label/label.js';import{Portal as gt}from'../portal/portal.js';var Lt=(o=>(o[o.Open=0]="Open",o[o.Closed=1]="Closed",o))(Lt||{}),St=(o=>(o[o.Single=0]="Single",o[o.Multi=1]="Multi",o))(St||{}),Et=(o=>(o[o.Pointer=0]="Pointer",o[o.Other=1]="Other",o))(Et||{}),Pt=(n=>(n[n.OpenListbox=0]="OpenListbox",n[n.CloseListbox=1]="CloseListbox",n[n.GoToOption=2]="GoToOption",n[n.Search=3]="Search",n[n.ClearSearch=4]="ClearSearch",n[n.RegisterOption=5]="RegisterOption",n[n.UnregisterOption=6]="UnregisterOption",n[n.SetButtonElement=7]="SetButtonElement",n[n.SetOptionsElement=8]="SetOptionsElement",n))(Pt||{});function Te(e,i=o=>o){let o=e.activeOptionIndex!==null?e.options[e.activeOptionIndex]:null,r=bt(i(e.options.slice()),m=>m.dataRef.current.domRef.current),a=o?r.indexOf(o):null;return a===-1&&(a=null),{options:r,activeOptionIndex:a}}let Rt={[1](e){return e.dataRef.current.disabled||e.listboxState===1?e:{...e,activeOptionIndex:null,listboxState:1,__demoMode:!1}},[0](e){if(e.dataRef.current.disabled||e.listboxState===0)return e;let i=e.activeOptionIndex,{isSelected:o}=e.dataRef.current,r=e.options.findIndex(a=>o(a.dataRef.current.value));return r!==-1&&(i=r),{...e,listboxState:0,activeOptionIndex:i,__demoMode:!1}},[2](e,i){var m,x,d,p,n;if(e.dataRef.current.disabled||e.listboxState===1)return e;let o={...e,searchQuery:"",activationTrigger:(m=i.trigger)!=null?m:1,__demoMode:!1};if(i.focus===v.Nothing)return{...o,activeOptionIndex:null};if(i.focus===v.Specific)return{...o,activeOptionIndex:e.options.findIndex(u=>u.id===i.id)};if(i.focus===v.Previous){let u=e.activeOptionIndex;if(u!==null){let P=e.options[u].dataRef.current.domRef,t=be(i,{resolveItems:()=>e.options,resolveActiveIndex:()=>e.activeOptionIndex,resolveId:s=>s.id,resolveDisabled:s=>s.dataRef.current.disabled});if(t!==null){let s=e.options[t].dataRef.current.domRef;if(((x=P.current)==null?void 0:x.previousElementSibling)===s.current||((d=s.current)==null?void 0:d.previousElementSibling)===null)return{...o,activeOptionIndex:t}}}}else if(i.focus===v.Next){let u=e.activeOptionIndex;if(u!==null){let P=e.options[u].dataRef.current.domRef,t=be(i,{resolveItems:()=>e.options,resolveActiveIndex:()=>e.activeOptionIndex,resolveId:s=>s.id,resolveDisabled:s=>s.dataRef.current.disabled});if(t!==null){let s=e.options[t].dataRef.current.domRef;if(((p=P.current)==null?void 0:p.nextElementSibling)===s.current||((n=s.current)==null?void 0:n.nextElementSibling)===null)return{...o,activeOptionIndex:t}}}}let r=Te(e),a=be(i,{resolveItems:()=>r.options,resolveActiveIndex:()=>r.activeOptionIndex,resolveId:u=>u.id,resolveDisabled:u=>u.dataRef.current.disabled});return{...o,...r,activeOptionIndex:a}},[3]:(e,i)=>{if(e.dataRef.current.disabled||e.listboxState===1)return e;let r=e.searchQuery!==""?0:1,a=e.searchQuery+i.value.toLowerCase(),x=(e.activeOptionIndex!==null?e.options.slice(e.activeOptionIndex+r).concat(e.options.slice(0,e.activeOptionIndex+r)):e.options).find(p=>{var n;return!p.dataRef.current.disabled&&((n=p.dataRef.current.textValue)==null?void 0:n.startsWith(a))}),d=x?e.options.indexOf(x):-1;return d===-1||d===e.activeOptionIndex?{...e,searchQuery:a}:{...e,searchQuery:a,activeOptionIndex:d,activationTrigger:1}},[4](e){return e.dataRef.current.disabled||e.listboxState===1||e.searchQuery===""?e:{...e,searchQuery:""}},[5]:(e,i)=>{let o={id:i.id,dataRef:i.dataRef},r=Te(e,a=>[...a,o]);return e.activeOptionIndex===null&&e.dataRef.current.isSelected(i.dataRef.current.value)&&(r.activeOptionIndex=r.options.indexOf(o)),{...e,...r}},[6]:(e,i)=>{let o=Te(e,r=>{let a=r.findIndex(m=>m.id===i.id);return a!==-1&&r.splice(a,1),r});return{...e,...o,activationTrigger:1}},[7]:(e,i)=>e.buttonElement===i.element?e:{...e,buttonElement:i.element},[8]:(e,i)=>e.optionsElement===i.element?e:{...e,optionsElement:i.element}},me=se(null);me.displayName="ListboxActionsContext";function Z(e){let i=ue(me);if(i===null){let o=new Error(`<${e} /> is missing a parent <Listbox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(o,Z),o}return i}let ee=se(null);ee.displayName="ListboxDataContext";function Q(e){let i=ue(ee);if(i===null){let o=new Error(`<${e} /> is missing a parent <Listbox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(o,Q),o}return i}function At(e,i){return V(i.type,Rt,e,i)}let ht=Oe;function Dt(e,i){var xe;let o=qe(),{value:r,defaultValue:a,form:m,name:x,onChange:d,by:p,invalid:n=!1,disabled:u=o||!1,horizontal:P=!1,multiple:t=!1,__demoMode:s=!1,outsideClickScope:F,...k}=e;const M=P?"horizontal":"vertical";let D=j(i),R=Ue(a),[E=t?[]:void 0,O]=ke(r,d,R),[_,y]=Fe(At,{dataRef:Ie(),listboxState:s?0:1,options:[],searchQuery:"",activeOptionIndex:null,activationTrigger:1,optionsVisible:!1,buttonElement:null,optionsElement:null,__demoMode:s}),U=de({static:!1,hold:!1}),B=de(new Map),f=we(p),A=pe(b=>V(c.mode,{[1]:()=>E.some(L=>f(L,b)),[0]:()=>f(E,b)}),[E]),c=w(()=>({..._,value:E,disabled:u,invalid:n,mode:t?1:0,orientation:M,compare:f,isSelected:A,optionsPropsRef:U,listRef:B}),[E,u,n,t,_,B]);fe(()=>{_.dataRef.current=c},[c]);let g=c.listboxState===0;je(g,[c.buttonElement,c.optionsElement],(b,L)=>{var C;y({type:1}),ft(L,dt.Loose)||(b.preventDefault(),(C=c.buttonElement)==null||C.focus())},F);let H=w(()=>({open:c.listboxState===0,disabled:u,invalid:n,value:E}),[c,u,E,n]),te=T(b=>{let L=c.options.find(C=>C.id===b);L&&K(L.dataRef.current.value)}),oe=T(()=>{if(c.activeOptionIndex!==null){let{dataRef:b,id:L}=c.options[c.activeOptionIndex];K(b.current.value),y({type:2,focus:v.Specific,id:L})}}),ne=T(()=>y({type:0})),X=T(()=>y({type:1})),J=ye(),ie=T((b,L,C)=>{J.dispose(),J.microTask(()=>b===v.Specific?y({type:2,focus:v.Specific,id:L,trigger:C}):y({type:2,focus:b,trigger:C}))}),re=T((b,L)=>(y({type:5,id:b,dataRef:L}),()=>y({type:6,id:b}))),K=T(b=>V(c.mode,{[0](){return O==null?void 0:O(b)},[1](){let L=c.value.slice(),C=L.findIndex(he=>f(he,b));return C===-1?L.push(b):L.splice(C,1),O==null?void 0:O(L)}})),le=T(b=>y({type:3,value:b})),$=T(()=>y({type:4})),q=T(b=>{y({type:7,element:b})}),l=T(b=>{y({type:8,element:b})}),I=w(()=>({onChange:K,registerOption:re,goToOption:ie,closeListbox:X,openListbox:ne,selectActiveOption:oe,selectOption:te,search:le,clearSearch:$,setButtonElement:q,setOptionsElement:l}),[]),[G,ae]=vt({inherit:!0}),Pe={ref:D},Re=pe(()=>{if(R!==void 0)return O==null?void 0:O(R)},[O,R]),Ae=W();return h.createElement(ae,{value:G,props:{htmlFor:(xe=c.buttonElement)==null?void 0:xe.id},slot:{open:c.listboxState===0,disabled:u}},h.createElement(Ye,null,h.createElement(me.Provider,{value:I},h.createElement(ee.Provider,{value:c},h.createElement(at,{value:V(c.listboxState,{[0]:Y.Open,[1]:Y.Closed})},x!=null&&E!=null&&h.createElement(it,{disabled:u,data:{[x]:E},form:m,onReset:Re}),Ae({ourProps:Pe,theirProps:k,slot:H,defaultTag:ht,name:"Listbox"}))))))}let _t="button";function It(e,i){var c;let o=Q("Listbox.Button"),r=Z("Listbox.Button"),a=ce(),m=lt(),{id:x=m||`headlessui-listbox-button-${a}`,disabled:d=o.disabled||!1,autoFocus:p=!1,...n}=e,u=j(i,tt(),r.setButtonElement),P=ot(),t=T(g=>{switch(g.key){case S.Enter:Tt(g.currentTarget);break;case S.Space:case S.ArrowDown:g.preventDefault(),N(()=>r.openListbox()),o.value||r.goToOption(v.First);break;case S.ArrowUp:g.preventDefault(),N(()=>r.openListbox()),o.value||r.goToOption(v.Last);break}}),s=T(g=>{switch(g.key){case S.Space:g.preventDefault();break}}),F=T(g=>{var H;if(pt(g.currentTarget))return g.preventDefault();o.listboxState===0?(N(()=>r.closeListbox()),(H=o.buttonElement)==null||H.focus({preventScroll:!0})):(g.preventDefault(),r.openListbox())}),k=T(g=>g.preventDefault()),M=yt([x]),D=xt(),{isFocusVisible:R,focusProps:E}=De({autoFocus:p}),{isHovered:O,hoverProps:_}=_e({isDisabled:d}),{pressed:y,pressProps:U}=Be({disabled:d}),B=w(()=>({open:o.listboxState===0,active:y||o.listboxState===0,disabled:d,invalid:o.invalid,value:o.value,hover:O,focus:R,autofocus:p}),[o.listboxState,o.value,d,O,R,y,o.invalid,p]),f=Se(P(),{ref:u,id:x,type:ze(e,o.buttonElement),"aria-haspopup":"listbox","aria-controls":(c=o.optionsElement)==null?void 0:c.id,"aria-expanded":o.listboxState===0,"aria-labelledby":M,"aria-describedby":D,disabled:d||void 0,autoFocus:p,onKeyDown:t,onKeyUp:s,onKeyPress:k,onClick:F},E,_,U);return W()({ourProps:f,theirProps:n,slot:B,defaultTag:_t,name:"Listbox.Button"})}let Ee=se(!1),Ct="div",Ft=Le.RenderStrategy|Le.Static;function Mt(e,i){var $,q;let o=ce(),{id:r=`headlessui-listbox-options-${o}`,anchor:a,portal:m=!1,modal:x=!0,transition:d=!1,...p}=e,n=nt(a),[u,P]=Me(null);n&&(m=!0);let t=Q("Listbox.Options"),s=Z("Listbox.Options"),F=ve(t.buttonElement),k=ve(t.optionsElement),M=st(),[D,R]=$e(d,u,M!==null?(M&Y.Open)===Y.Open:t.listboxState===0);Ke(D,t.buttonElement,s.closeListbox);let E=t.__demoMode?!1:x&&t.listboxState===0;We(E,k);let O=t.__demoMode?!1:x&&t.listboxState===0;Ge(O,{allowed:pe(()=>[t.buttonElement,t.optionsElement],[t.buttonElement,t.optionsElement])});let _=t.listboxState!==0,U=Ne(_,t.buttonElement)?!1:D,B=D&&t.listboxState===1,f=rt(B,t.value),A=T(l=>t.compare(f,l)),c=w(()=>{var I;if(n==null||!((I=n==null?void 0:n.to)!=null&&I.includes("selection")))return null;let l=t.options.findIndex(G=>A(G.dataRef.current.value));return l===-1&&(l=0),l},[n,t.options]),g=(()=>{if(n==null)return;if(c===null)return{...n,inner:void 0};let l=Array.from(t.listRef.current.values());return{...n,inner:{listRef:{current:l},index:c}}})(),[H,te]=Ze(g),oe=et(),ne=j(i,n?H:null,s.setOptionsElement,P),X=ye();Ce(()=>{var I;let l=t.optionsElement;l&&t.listboxState===0&&l!==((I=mt(l))==null?void 0:I.activeElement)&&(l==null||l.focus({preventScroll:!0}))},[t.listboxState,t.optionsElement]);let J=T(l=>{var I,G;switch(X.dispose(),l.key){case S.Space:if(t.searchQuery!=="")return l.preventDefault(),l.stopPropagation(),s.search(l.key);case S.Enter:if(l.preventDefault(),l.stopPropagation(),t.activeOptionIndex!==null){let{dataRef:ae}=t.options[t.activeOptionIndex];s.onChange(ae.current.value)}t.mode===0&&(N(()=>s.closeListbox()),(I=t.buttonElement)==null||I.focus({preventScroll:!0}));break;case V(t.orientation,{vertical:S.ArrowDown,horizontal:S.ArrowRight}):return l.preventDefault(),l.stopPropagation(),s.goToOption(v.Next);case V(t.orientation,{vertical:S.ArrowUp,horizontal:S.ArrowLeft}):return l.preventDefault(),l.stopPropagation(),s.goToOption(v.Previous);case S.Home:case S.PageUp:return l.preventDefault(),l.stopPropagation(),s.goToOption(v.First);case S.End:case S.PageDown:return l.preventDefault(),l.stopPropagation(),s.goToOption(v.Last);case S.Escape:l.preventDefault(),l.stopPropagation(),N(()=>s.closeListbox()),(G=t.buttonElement)==null||G.focus({preventScroll:!0});return;case S.Tab:l.preventDefault(),l.stopPropagation(),N(()=>s.closeListbox()),ct(t.buttonElement,l.shiftKey?ge.Previous:ge.Next);break;default:l.key.length===1&&(s.search(l.key),X.setTimeout(()=>s.clearSearch(),350));break}}),ie=($=t.buttonElement)==null?void 0:$.id,re=w(()=>({open:t.listboxState===0}),[t.listboxState]),K=Se(n?oe():{},{id:r,ref:ne,"aria-activedescendant":t.activeOptionIndex===null||(q=t.options[t.activeOptionIndex])==null?void 0:q.id,"aria-multiselectable":t.mode===1?!0:void 0,"aria-labelledby":ie,"aria-orientation":t.orientation,onKeyDown:J,role:"listbox",tabIndex:t.listboxState===0?0:void 0,style:{...p.style,...te,"--button-width":He(t.buttonElement,!0).width},...Je(R)}),le=W();return h.createElement(gt,{enabled:m?e.static||D:!1,ownerDocument:F},h.createElement(ee.Provider,{value:t.mode===1?t:{...t,isSelected:A}},le({ourProps:K,theirProps:p,slot:re,defaultTag:Ct,features:Ft,visible:U,name:"Listbox.Options"})))}let Bt="div";function wt(e,i){let o=ce(),{id:r=`headlessui-listbox-option-${o}`,disabled:a=!1,value:m,...x}=e,d=ue(Ee)===!0,p=Q("Listbox.Option"),n=Z("Listbox.Option"),u=p.activeOptionIndex!==null?p.options[p.activeOptionIndex].id===r:!1,P=p.isSelected(m),t=de(null),s=Qe(t),F=Ve({disabled:a,value:m,domRef:t,get textValue(){return s()}}),k=j(i,t,f=>{f?p.listRef.current.set(r,f):p.listRef.current.delete(r)});fe(()=>{if(!p.__demoMode&&p.listboxState===0&&u&&p.activationTrigger!==0)return ut().requestAnimationFrame(()=>{var f,A;(A=(f=t.current)==null?void 0:f.scrollIntoView)==null||A.call(f,{block:"nearest"})})},[t,u,p.__demoMode,p.listboxState,p.activationTrigger,p.activeOptionIndex]),fe(()=>{if(!d)return n.registerOption(r,F)},[F,r,d]);let M=T(f=>{var A;if(a)return f.preventDefault();n.onChange(m),p.mode===0&&(N(()=>n.closeListbox()),(A=p.buttonElement)==null||A.focus({preventScroll:!0}))}),D=T(()=>{if(a)return n.goToOption(v.Nothing);n.goToOption(v.Specific,r)}),R=Xe(),E=T(f=>{R.update(f),!a&&(u||n.goToOption(v.Specific,r,0))}),O=T(f=>{R.wasMoved(f)&&(a||u||n.goToOption(v.Specific,r,0))}),_=T(f=>{R.wasMoved(f)&&(a||u&&n.goToOption(v.Nothing))}),y=w(()=>({active:u,focus:u,selected:P,disabled:a,selectedOption:P&&d}),[u,P,a,d]),U=d?{}:{id:r,ref:k,role:"option",tabIndex:a===!0?void 0:-1,"aria-disabled":a===!0?!0:void 0,"aria-selected":P,disabled:void 0,onClick:M,onFocus:D,onPointerEnter:E,onMouseEnter:E,onPointerMove:O,onMouseMove:O,onPointerLeave:_,onMouseLeave:_},B=W();return!P&&d?null:B({ourProps:U,theirProps:x,slot:y,defaultTag:Bt,name:"Listbox.Option"})}let kt=Oe;function Ut(e,i){let{options:o,placeholder:r,...a}=e,x={ref:j(i)},d=Q("ListboxSelectedOption"),p=w(()=>({}),[]),n=d.value===void 0||d.value===null||d.mode===1&&Array.isArray(d.value)&&d.value.length===0,u=W();return h.createElement(Ee.Provider,{value:!0},u({ourProps:x,theirProps:{...a,children:h.createElement(h.Fragment,null,r&&n?r:o)},slot:p,defaultTag:kt,name:"ListboxSelectedOption"}))}let Nt=z(Dt),Ht=z(It),Gt=Ot,Vt=z(Mt),Kt=z(wt),jt=z(Ut),Bo=Object.assign(Nt,{Button:Ht,Label:Gt,Options:Vt,Option:Kt,SelectedOption:jt});export{Bo as Listbox,Ht as ListboxButton,Gt as ListboxLabel,Kt as ListboxOption,Vt as ListboxOptions,jt as ListboxSelectedOption};
