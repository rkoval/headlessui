"use client";import{useFocusRing as Ie}from"@react-aria/focus";import{useHover as De}from"@react-aria/interactions";import m,{createContext as re,createRef as ce,useContext as ne,useEffect as le,useMemo as h,useReducer as he,useRef as te,useState as ae}from"react";import{useActivePress as ke}from'../../hooks/use-active-press.js';import{useElementSize as Ge}from'../../hooks/use-element-size.js';import{useEvent as g}from'../../hooks/use-event.js';import{useEventListener as He}from'../../hooks/use-event-listener.js';import{useId as pe}from'../../hooks/use-id.js';import{useIsoMorphicEffect as Ue}from'../../hooks/use-iso-morphic-effect.js';import{useLatestValue as Ce}from'../../hooks/use-latest-value.js';import{useOnDisappear as Ne}from'../../hooks/use-on-disappear.js';import{useOutsideClick as we}from'../../hooks/use-outside-click.js';import{useOwnerDocument as se}from'../../hooks/use-owner.js';import{useResolveButtonType as Ke}from'../../hooks/use-resolve-button-type.js';import{MainTreeProvider as Re,useMainTreeNode as We,useRootContainers as je}from'../../hooks/use-root-containers.js';import{useScrollLock as Ve}from'../../hooks/use-scroll-lock.js';import{optionalRef as $e,useSyncRefs as Y}from'../../hooks/use-sync-refs.js';import{Direction as G,useTabDirection as Be}from'../../hooks/use-tab-direction.js';import{transitionDataAttributes as _e,useTransition as Fe}from'../../hooks/use-transition.js';import{CloseProvider as Je}from'../../internal/close-provider.js';import{FloatingProvider as Xe,useFloatingPanel as qe,useFloatingPanelProps as ze,useFloatingReference as Ye,useResolvedAnchor as Qe}from'../../internal/floating.js';import{Hidden as ve,HiddenFeatures as Te}from'../../internal/hidden.js';import{OpenClosedProvider as Ze,ResetOpenClosedProvider as et,State as Q,useOpenClosed as xe}from'../../internal/open-closed.js';import{isDisabledReactIssue7711 as Me}from'../../utils/bugs.js';import{Focus as H,FocusResult as me,FocusableMode as tt,focusIn as j,getFocusableElements as ye,isFocusableElement as ot}from'../../utils/focus-management.js';import{match as V}from'../../utils/match.js';import'../../utils/micro-task.js';import{getOwnerDocument as rt}from'../../utils/owner.js';import{RenderFeatures as ue,forwardRefWithAs as Z,mergeProps as Ee,useRender as oe}from'../../utils/render.js';import{Keys as $}from'../keyboard.js';import{Portal as nt,useNestedPortals as lt}from'../portal/portal.js';var at=(u=>(u[u.Open=0]="Open",u[u.Closed=1]="Closed",u))(at||{}),pt=(p=>(p[p.TogglePopover=0]="TogglePopover",p[p.ClosePopover=1]="ClosePopover",p[p.SetButton=2]="SetButton",p[p.SetButtonId=3]="SetButtonId",p[p.SetPanel=4]="SetPanel",p[p.SetPanelId=5]="SetPanelId",p))(pt||{});let st={[0]:o=>({...o,popoverState:V(o.popoverState,{[0]:1,[1]:0}),__demoMode:!1}),[1](o){return o.popoverState===1?o:{...o,popoverState:1,__demoMode:!1}},[2](o,a){return o.button===a.button?o:{...o,button:a.button}},[3](o,a){return o.buttonId===a.buttonId?o:{...o,buttonId:a.buttonId}},[4](o,a){return o.panel===a.panel?o:{...o,panel:a.panel}},[5](o,a){return o.panelId===a.panelId?o:{...o,panelId:a.panelId}}},be=re(null);be.displayName="PopoverContext";function ie(o){let a=ne(be);if(a===null){let u=new Error(`<${o} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(u,ie),u}return a}let de=re(null);de.displayName="PopoverAPIContext";function ge(o){let a=ne(de);if(a===null){let u=new Error(`<${o} /> is missing a parent <Popover /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(u,ge),u}return a}let Se=re(null);Se.displayName="PopoverGroupContext";function Oe(){return ne(Se)}let Pe=re(null);Pe.displayName="PopoverPanelContext";function ut(){return ne(Pe)}function it(o,a){return V(a.type,st,o,a)}let dt="div";function Pt(o,a){var z;let{__demoMode:u=!1,outsideClickScope:C,...y}=o,S=te(null),p=Y(a,$e(e=>{S.current=e})),n=te([]),c=he(it,{__demoMode:u,popoverState:u?0:1,buttons:n,button:null,buttonId:null,panel:null,panelId:null,beforePanelSentinel:ce(),afterPanelSentinel:ce(),afterButtonSentinel:ce()}),[{popoverState:A,button:t,buttonId:E,panel:P,panelId:v,beforePanelSentinel:k,afterPanelSentinel:s,afterButtonSentinel:l},T]=c,f=se((z=S.current)!=null?z:t),B=h(()=>{if(!t||!P)return!1;for(let b of document.querySelectorAll("body > *"))if(Number(b==null?void 0:b.contains(t))^Number(b==null?void 0:b.contains(P)))return!0;let e=ye(),r=e.indexOf(t),d=(r+e.length-1)%e.length,i=(r+1)%e.length,D=e[d],_=e[i];return!P.contains(D)&&!P.contains(_)},[t,P]),x=Ce(E),O=Ce(v),U=h(()=>({buttonId:x,panelId:O,close:()=>T({type:1})}),[x,O,T]),M=Oe(),L=M==null?void 0:M.registerPopover,R=g(()=>{var e;return(e=M==null?void 0:M.isFocusWithinPopoverGroup())!=null?e:(f==null?void 0:f.activeElement)&&((t==null?void 0:t.contains(f.activeElement))||(P==null?void 0:P.contains(f.activeElement)))});le(()=>L==null?void 0:L(U),[L,U]);let[N,F]=lt(),w=We(t),K=je({mainTreeNode:w,portals:N,defaultContainers:[t,P]});He(f==null?void 0:f.defaultView,"focus",e=>{var r,d,i,D,_,b;e.target!==window&&e.target instanceof HTMLElement&&A===0&&(R()||t&&P&&(K.contains(e.target)||(d=(r=k.current)==null?void 0:r.contains)!=null&&d.call(r,e.target)||(D=(i=s.current)==null?void 0:i.contains)!=null&&D.call(i,e.target)||(b=(_=l.current)==null?void 0:_.contains)!=null&&b.call(_,e.target)||T({type:1})))},!0),we(A===0,K.resolveContainers,(e,r)=>{T({type:1}),ot(r,tt.Loose)||(e.preventDefault(),t==null||t.focus())},C);let I=g(e=>{T({type:1});let r=(()=>e?e instanceof HTMLElement?e:"current"in e&&e.current instanceof HTMLElement?e.current:t:t)();r==null||r.focus()}),J=h(()=>({close:I,isPortalled:B}),[I,B]),X=h(()=>({open:A===0,close:I}),[A,I]),q={ref:p},ee=oe();return m.createElement(Re,{node:w},m.createElement(Xe,null,m.createElement(Pe.Provider,{value:null},m.createElement(be.Provider,{value:c},m.createElement(de.Provider,{value:J},m.createElement(Je,{value:I},m.createElement(Ze,{value:V(A,{[0]:Q.Open,[1]:Q.Closed})},m.createElement(F,null,ee({ourProps:q,theirProps:y,slot:X,defaultTag:dt,name:"Popover"})))))))))}let ft="button";function ct(o,a){let u=pe(),{id:C=`headlessui-popover-button-${u}`,disabled:y=!1,autoFocus:S=!1,...p}=o,[n,c]=ie("Popover.Button"),{isPortalled:A}=ge("Popover.Button"),t=te(null),E=`headlessui-focus-sentinel-${pe()}`,P=Oe(),v=P==null?void 0:P.closeOthers,s=ut()!==null;le(()=>{if(!s)return c({type:3,buttonId:C}),()=>{c({type:3,buttonId:null})}},[s,C,c]);let[l]=ae(()=>Symbol()),T=Y(t,a,Ye(),g(e=>{if(!s){if(e)n.buttons.current.push(l);else{let r=n.buttons.current.indexOf(l);r!==-1&&n.buttons.current.splice(r,1)}n.buttons.current.length>1&&console.warn("You are already using a <Popover.Button /> but only 1 <Popover.Button /> is supported."),e&&c({type:2,button:e})}})),f=Y(t,a),B=se(t),x=g(e=>{var r,d,i;if(s){if(n.popoverState===1)return;switch(e.key){case $.Space:case $.Enter:e.preventDefault(),(d=(r=e.target).click)==null||d.call(r),c({type:1}),(i=n.button)==null||i.focus();break}}else switch(e.key){case $.Space:case $.Enter:e.preventDefault(),e.stopPropagation(),n.popoverState===1&&(v==null||v(n.buttonId)),c({type:0});break;case $.Escape:if(n.popoverState!==0)return v==null?void 0:v(n.buttonId);if(!t.current||B!=null&&B.activeElement&&!t.current.contains(B.activeElement))return;e.preventDefault(),e.stopPropagation(),c({type:1});break}}),O=g(e=>{s||e.key===$.Space&&e.preventDefault()}),U=g(e=>{var r,d;Me(e.currentTarget)||y||(s?(c({type:1}),(r=n.button)==null||r.focus()):(e.preventDefault(),e.stopPropagation(),n.popoverState===1&&(v==null||v(n.buttonId)),c({type:0}),(d=n.button)==null||d.focus()))}),M=g(e=>{e.preventDefault(),e.stopPropagation()}),{isFocusVisible:L,focusProps:R}=Ie({autoFocus:S}),{isHovered:N,hoverProps:F}=De({isDisabled:y}),{pressed:w,pressProps:K}=ke({disabled:y}),W=n.popoverState===0,I=h(()=>({open:W,active:w||W,disabled:y,hover:N,focus:L,autofocus:S}),[W,N,L,w,y,S]),J=Ke(o,n.button),X=s?Ee({ref:f,type:J,onKeyDown:x,onClick:U,disabled:y||void 0,autoFocus:S},R,F,K):Ee({ref:T,id:n.buttonId,type:J,"aria-expanded":n.popoverState===0,"aria-controls":n.panel?n.panelId:void 0,disabled:y||void 0,autoFocus:S,onKeyDown:x,onKeyUp:O,onClick:U,onMouseDown:M},R,F,K),q=Be(),ee=g(()=>{let e=n.panel;if(!e)return;function r(){V(q.current,{[G.Forwards]:()=>j(e,H.First),[G.Backwards]:()=>j(e,H.Last)})===me.Error&&j(ye().filter(i=>i.dataset.headlessuiFocusGuard!=="true"),V(q.current,{[G.Forwards]:H.Next,[G.Backwards]:H.Previous}),{relativeTo:n.button})}r()}),z=oe();return m.createElement(m.Fragment,null,z({ourProps:X,theirProps:p,slot:I,defaultTag:ft,name:"Popover.Button"}),W&&!s&&A&&m.createElement(ve,{id:E,ref:n.afterButtonSentinel,features:Te.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:ee}))}let vt="div",Tt=ue.RenderStrategy|ue.Static;function Le(o,a){let u=pe(),{id:C=`headlessui-popover-backdrop-${u}`,transition:y=!1,...S}=o,[{popoverState:p},n]=ie("Popover.Backdrop"),[c,A]=ae(null),t=Y(a,A),E=xe(),[P,v]=Fe(y,c,E!==null?(E&Q.Open)===Q.Open:p===0),k=g(f=>{if(Me(f.currentTarget))return f.preventDefault();n({type:1})}),s=h(()=>({open:p===0}),[p]),l={ref:t,id:C,"aria-hidden":!0,onClick:k,..._e(v)};return oe()({ourProps:l,theirProps:S,slot:s,defaultTag:vt,features:Tt,visible:P,name:"Popover.Backdrop"})}let mt="div",yt=ue.RenderStrategy|ue.Static;function Et(o,a){let u=pe(),{id:C=`headlessui-popover-panel-${u}`,focus:y=!1,anchor:S,portal:p=!1,modal:n=!1,transition:c=!1,...A}=o,[t,E]=ie("Popover.Panel"),{close:P,isPortalled:v}=ge("Popover.Panel"),k=`headlessui-focus-sentinel-before-${u}`,s=`headlessui-focus-sentinel-after-${u}`,l=te(null),T=Qe(S),[f,B]=qe(T),x=ze();T&&(p=!0);let[O,U]=ae(null),M=Y(l,a,T?f:null,g(e=>E({type:4,panel:e})),U),L=se(t.button),R=se(l);Ue(()=>(E({type:5,panelId:C}),()=>{E({type:5,panelId:null})}),[C,E]);let N=xe(),[F,w]=Fe(c,O,N!==null?(N&Q.Open)===Q.Open:t.popoverState===0);Ne(F,t.button,()=>{E({type:1})});let K=t.__demoMode?!1:n&&F;Ve(K,R);let W=g(e=>{var r;switch(e.key){case $.Escape:if(t.popoverState!==0||!l.current||R!=null&&R.activeElement&&!l.current.contains(R.activeElement))return;e.preventDefault(),e.stopPropagation(),E({type:1}),(r=t.button)==null||r.focus();break}});le(()=>{var e;o.static||t.popoverState===1&&((e=o.unmount)==null||e)&&E({type:4,panel:null})},[t.popoverState,o.unmount,o.static,E]),le(()=>{if(t.__demoMode||!y||t.popoverState!==0||!l.current)return;let e=R==null?void 0:R.activeElement;l.current.contains(e)||j(l.current,H.First)},[t.__demoMode,y,l.current,t.popoverState]);let I=h(()=>({open:t.popoverState===0,close:P}),[t.popoverState,P]),J=Ee(T?x():{},{ref:M,id:C,onKeyDown:W,onBlur:y&&t.popoverState===0?e=>{var d,i,D,_,b;let r=e.relatedTarget;r&&l.current&&((d=l.current)!=null&&d.contains(r)||(E({type:1}),((D=(i=t.beforePanelSentinel.current)==null?void 0:i.contains)!=null&&D.call(i,r)||(b=(_=t.afterPanelSentinel.current)==null?void 0:_.contains)!=null&&b.call(_,r))&&r.focus({preventScroll:!0})))}:void 0,tabIndex:-1,style:{...A.style,...B,"--button-width":Ge(t.button,!0).width},..._e(w)}),X=Be(),q=g(()=>{let e=l.current;if(!e)return;function r(){V(X.current,{[G.Forwards]:()=>{var i;j(e,H.First)===me.Error&&((i=t.afterPanelSentinel.current)==null||i.focus())},[G.Backwards]:()=>{var d;(d=t.button)==null||d.focus({preventScroll:!0})}})}r()}),ee=g(()=>{let e=l.current;if(!e)return;function r(){V(X.current,{[G.Forwards]:()=>{if(!t.button)return;let d=ye(),i=d.indexOf(t.button),D=d.slice(0,i+1),b=[...d.slice(i+1),...D];for(let fe of b.slice())if(fe.dataset.headlessuiFocusGuard==="true"||O!=null&&O.contains(fe)){let Ae=b.indexOf(fe);Ae!==-1&&b.splice(Ae,1)}j(b,H.First,{sorted:!1})},[G.Backwards]:()=>{var i;j(e,H.Previous)===me.Error&&((i=t.button)==null||i.focus())}})}r()}),z=oe();return m.createElement(et,null,m.createElement(Pe.Provider,{value:C},m.createElement(de.Provider,{value:{close:P,isPortalled:v}},m.createElement(nt,{enabled:p?o.static||F:!1,ownerDocument:L},F&&v&&m.createElement(ve,{id:k,ref:t.beforePanelSentinel,features:Te.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:q}),z({ourProps:J,theirProps:A,slot:I,defaultTag:mt,features:yt,visible:F,name:"Popover.Panel"}),F&&v&&m.createElement(ve,{id:s,ref:t.afterPanelSentinel,features:Te.Focusable,"data-headlessui-focus-guard":!0,as:"button",type:"button",onFocus:ee})))))}let bt="div";function gt(o,a){let u=te(null),C=Y(u,a),[y,S]=ae([]),p=g(s=>{S(l=>{let T=l.indexOf(s);if(T!==-1){let f=l.slice();return f.splice(T,1),f}return l})}),n=g(s=>(S(l=>[...l,s]),()=>p(s))),c=g(()=>{var T;let s=rt(u);if(!s)return!1;let l=s.activeElement;return(T=u.current)!=null&&T.contains(l)?!0:y.some(f=>{var B,x;return((B=s.getElementById(f.buttonId.current))==null?void 0:B.contains(l))||((x=s.getElementById(f.panelId.current))==null?void 0:x.contains(l))})}),A=g(s=>{for(let l of y)l.buttonId.current!==s&&l.close()}),t=h(()=>({registerPopover:n,unregisterPopover:p,isFocusWithinPopoverGroup:c,closeOthers:A}),[n,p,c,A]),E=h(()=>({}),[]),P=o,v={ref:C},k=oe();return m.createElement(Re,null,m.createElement(Se.Provider,{value:t},k({ourProps:v,theirProps:P,slot:E,defaultTag:bt,name:"Popover.Group"})))}let St=Z(Pt),At=Z(ct),Ct=Z(Le),Rt=Z(Le),Bt=Z(Et),_t=Z(gt),ao=Object.assign(St,{Button:At,Backdrop:Rt,Overlay:Ct,Panel:Bt,Group:_t});export{ao as Popover,Rt as PopoverBackdrop,At as PopoverButton,_t as PopoverGroup,Ct as PopoverOverlay,Bt as PopoverPanel};
